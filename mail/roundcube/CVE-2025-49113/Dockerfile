FROM ubuntu:24.04
LABEL maintainer="the29a"

ARG DEBIAN_FRONTEND=noninteractive
ENV php_version="8.3"
ENV TARGET_VERSION="1.6.10"
ENV TZ=Europe/Moscow
ENV DB_PASS="mariadb_password"
ENV COMPOSER_ALLOW_SUPERUSER=1 

RUN apt update -y && \
    apt install -y -qq --no-install-recommends \
    supervisor \
    apache2 \
    php${php_version} \
    php${php_version}-mysql \
    php${php_version}-intl \
    php${php_version}-mbstring \
    php${php_version}-xml \
    php${php_version}-common \
    php${php_version}-cli \
    php${php_version}-curl \
    php${php_version}-zip \
    php${php_version}-gd \
    php${php_version}-imagick \
    unzip \
    mariadb-client \
    dovecot-imapd \
    dovecot-pop3d \
    composer \
    bsd-mailx \
    wget \
    curl

# Download Roundcube
WORKDIR /tmp
RUN wget "https://github.com/roundcube/roundcubemail/releases/download/${TARGET_VERSION}/roundcubemail-${TARGET_VERSION}-complete.tar.gz" -O roundcube.tar.gz && \
    mkdir roundcube && \
    tar --strip-components=1 -xzf roundcube.tar.gz -C roundcube && \
    mv roundcube/* /var/www/html

# Installing PHP dependencies with Composer
WORKDIR /var/www/html
RUN mv composer.json-dist composer.json && \
    composer update && \
    composer install --no-dev && \
    rm index.html && \
    chown -R www-data:www-data /var/www/html/

# Configure Roundcube
RUN cp /var/www/html/config/config.inc.php.sample /var/www/html/config/config.inc.php && \
    sed -i "s#^\$config\['db_dsnw'\].*#\$config['db_dsnw'] = 'mysql://vulnforge:vulnforge123@db/roundcube';#" /var/www/html/config/config.inc.php && \
    echo "\$config['default_host'] = 'localhost';" >> /var/www/html/config/config.inc.php && \
    echo "\$config['smtp_server'] = 'localhost';" >> /var/www/html/config/config.inc.php


# Configuring Dovecot
RUN sed -i "s|^#mail_location =.*|mail_location = mbox:~/mail:INBOX=/var/mail/%u|" /etc/dovecot/conf.d/10-mail.conf && \
    sed -i "s|^#disable_plaintext_auth =.*|disable_plaintext_auth = no|" /etc/dovecot/conf.d/10-auth.conf && \
    sed -i "s|^auth_mechanisms =.*|auth_mechanisms = plain login|" /etc/dovecot/conf.d/10-auth.conf

# Creating system test user 'roundcube'..."
RUN useradd -m vulnforge && \
    echo "vulnforge:vulnforge123" | chpasswd

RUN echo "This is a test email to confirm Roundcube can access system mailboxes." | mail -s "Test Mail" vulnforge

RUN rm -rf /var/www/html/installer

COPY init.sh /init.sh
COPY supervisord.conf /etc/supervisor/supervisord.conf
RUN chmod +x /init.sh
ENTRYPOINT ["/init.sh"]