FROM ubuntu:24.04
LABEL maintainer="the29a"

ENV TZ=Europe/Moscow

ARG VB6_DB_HOST
ARG VB6_DB_USER
ARG VB6_DB_PASSWORD
ARG VB6_DB_NAME

# May contain useless php libs. vBulletin documentation is piece of shit and don`t cover docker install case
RUN apt update \
    && apt install -qq -y \
        php8.3 \
        php8.3-imagick  \
        php8.3-opcache \
        php8.3-mysql \
        php8.3-mbstring \
        php8.3-curl \
        php8.3-gd \
        php8.3-xml \
        wget \
        unrar \
    && apt clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# If you add vBulletin, place vb6 near docker
# COPY vb6/upload /var/www/html

# Or download nulled version: 6.0.3
# https://enxf.cc/threads/vbulletin-6-0-3-is-available-for-download.18091/
RUN wget https://enxf.cc/attachments/vb6_6-0-3-rar.39414/ -O vb6.rar && \
    unrar -inul x vb6.rar && \
    mv vb6_6-0-3/upload/* /var/www/html

# Piracy are bad, m-m-m-kay?

WORKDIR /var/www/html/
RUN chown -R www-data:www-data /var/www/html/  && \
    chmod 444 ./core/includes/md5_sums_vbulletin.php && \
    a2enmod rewrite && \
    rm /var/www/html/index.html && \
    mv htaccess.txt .htaccess

RUN sed -i 's/AllowOverride None/AllowOverride All /' /etc/apache2/apache2.conf 

# RUN cp core/includes/config.php.new core/includes/config.php && \
#     sed -i "s#\$config\['MasterServer'\]\['servername'\] = 'localhost';#\$config['MasterServer']['servername'] = 'db';#g" core/includes/config.php && \
#     sed -i "s#\$config\['MasterServer'\]\['username'\] = 'root';#\$config['MasterServer']['username'] = 'vbulletin';#g" core/includes/config.php && \
#     sed -i "s#\$config\['MasterServer'\]\['password'\] = '';#\$config['MasterServer']['password'] = 'vbulletin';#g" core/includes/config.php && \
#     sed -i "s#\$config\['Database'\]\['dbname'\] = 'forum';#\$config['Database']['dbname'] = 'vulnforum';#g" core/includes/config.php && \
#     rm ./core/install/makeconfig.php  

EXPOSE 8080

COPY init.sh /usr/local/bin/init.sh
RUN chmod +x /usr/local/bin/init.sh