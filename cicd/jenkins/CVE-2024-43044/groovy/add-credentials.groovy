import jenkins.model.*
import com.cloudbees.plugins.credentials.domains.Domain
import com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey
import com.cloudbees.jenkins.plugins.sshcredentials.impl.BasicSSHUserPrivateKey.DirectEntryPrivateKeySource
import com.cloudbees.plugins.credentials.CredentialsScope

def domain = Domain.global()
def credentialsStore = Jenkins.instance.getExtensionList('com.cloudbees.plugins.credentials.SystemCredentialsProvider')[0].getStore()

def privateKeyFile = new File('/var/lib/jenkins/.ssh/id_rsa')

if (!privateKeyFile.exists()) {
    println "Private key file not found: ${privateKeyFile.path}"
    return
}

def privateKey = new BasicSSHUserPrivateKey(
    CredentialsScope.GLOBAL,
    'vulnforge-ssh-key', // uniq key id
    'jenkins', // username
    new DirectEntryPrivateKeySource(privateKeyFile.text), // Используем содержимое файла как прямой ввод ключа
    null, // passphare (if exist)
    'VulnForge SSH Key' // Key description
)

credentialsStore.addCredentials(domain, privateKey)

println "SSH key added successfully."
