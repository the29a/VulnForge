FROM ubuntu:24.04
LABEL maintainer="the29a"

#LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php

ARG DEBIAN_FRONTEND=noninteractive
ENV TARGET_VERSION="1.11.10"
ENV PHP_VERSION="8.3"
ENV TZ=Europe/Moscow
ENV COMPOSER_ALLOW_SUPERUSER=1

ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.2.34/supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=e8631edc1775000d119b70fd40339a7238eece14 \
    SUPERCRONIC=supercronic-linux-amd64
ENV DB_PASS="mariadb_password"

RUN apt update && \
    apt install -y -qq software-properties-common \
    curl \
    apt-transport-https \
    ca-certificates \
    gnupg \
    tzdata && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone && \
    dpkg-reconfigure -f noninteractive tzdata

# Add Redis official APT repository
RUN curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" \
    | tee /etc/apt/sources.list.d/redis.list

# Update repositories list
RUN apt update ; apt -y -qq install unzip \
    php${PHP_VERSION} \
    php${PHP_VERSION}-common \
    php${PHP_VERSION}-cli \
    php${PHP_VERSION}-gd \
    php${PHP_VERSION}-mysql \
    php${PHP_VERSION}-mbstring \
    php${PHP_VERSION}-bcmath \
    php${PHP_VERSION}-xml \
    php${PHP_VERSION}-fpm \
    php${PHP_VERSION}-curl \
    php${PHP_VERSION}-zip \
    mariadb-server \
    tar \
    unzip \
    git \
    redis \
    redis-server \
    apache2 \
    supervisor \
    wget \
    libapache2-mod-php${PHP_VERSION}

# Add supercronic
RUN curl -fsSLO "$SUPERCRONIC_URL" \
    && echo "${SUPERCRONIC_SHA1SUM}  ${SUPERCRONIC}" | sha1sum -c - \
    && chmod +x "$SUPERCRONIC" \
    && mv "$SUPERCRONIC" "/usr/local/bin/${SUPERCRONIC}" \
    && ln -s "/usr/local/bin/${SUPERCRONIC}" /usr/local/bin/supercronic

RUN sysctl vm.overcommit_memory=1

# Add composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer


WORKDIR /tmp
RUN wget "https://github.com/pterodactyl/panel/releases/download/v${TARGET_VERSION}/panel.tar.gz" -O panel.tar.gz \
    && mkdir pterodactyl \
    && tar -xzf panel.tar.gz -C pterodactyl/ \
    && cp -r pterodactyl/ /var/www/ \
    && mkdir -p /var/www/pterodactyl \
    && chmod -R 755 /var/www/pterodactyl/storage/ /var/www/pterodactyl/bootstrap/cache/ \
    && a2dissite 000-default.conf 

WORKDIR /var/www/pterodactyl

COPY pterodactyl.conf /etc/apache2/sites-available

RUN mkdir -p /etc/crontabs \
    && echo "* * * * * php /var/www/pterodactyl/artisan schedule:run >> /dev/null 2>&1" > /etc/crontabs/pterodactyl

COPY pterodaq.conf /etc/supervisor/conf.d/pterodaq.conf

COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]