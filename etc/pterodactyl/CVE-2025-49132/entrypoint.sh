#!/bin/sh

echo -n "Waiting for MariaDB"
until mysqladmin -h db ping -p${DB_PASS} --silent; do
    sleep 1
    echo -n "."
done
echo " MariaDB is up"

mysql -h db -u root -p${DB_PASS} -e "CREATE DATABASE IF NOT EXISTS panel;"
mysql -h db -u root -p${DB_PASS} -e "CREATE USER IF NOT EXISTS 'vulnforge'@'%' IDENTIFIED BY 'vulnforge123';"
mysql -h db -u root -p${DB_PASS} -e "GRANT ALL PRIVILEGES ON panel.* TO 'vulnforge'@'%' WITH GRANT OPTION;;"
mysql -h db -u root -p${DB_PASS} -e "FLUSH PRIVILEGES;"
# mysql -h db -u root -p${DB_PASS} roundcube < /var/www/html/SQL/mysql.initial.sql


cp .env.example .env
composer install --no-dev --optimize-autoloader --quiet 

ln -s /etc/apache2/sites-available/pterodactyl.conf /etc/apache2/sites-enabled/pterodactyl.conf
a2enmod rewrite

# ##
#tail -f /dev/null

php artisan p:user:delete -n -q --user=vulnforge 2&>/dev/null

php artisan key:generate --force -n &&
    php artisan p:environment:setup -n &&
    php artisan p:environment:database \
        --host=db \
        --port=3306 \
        --database=panel \
        --username=vulnforge \
        --password=vulnforge123 \
        --no-interaction &&
    php artisan migrate --seed --force &&
    php artisan p:user:make \
        --username=vulnforge \
        --password=vulnforge123 \
        --admin=1 \
        --email=vulnforge@local.net \
        --name-first=Vuln \
        --name-last=Forge

chown -R www-data:www-data /var/www/pterodactyl/
# Run supervisord
supercronic /etc/crontabs/pterodactyl &

exec /usr/bin/supervisord -c /etc/supervisor/conf.d/pterodaq.conf
