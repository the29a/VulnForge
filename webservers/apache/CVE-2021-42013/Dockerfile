FROM ubuntu:20.04
LABEL maintaner="the29a"

# WORKDIR /root
# ENV TZ=Europe/Moscow
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN apt update ; apt install -y \
	wget \
	make \
	build-essential \
	automake \
	autoconf \
	bzip2 \
	libapr1-dev \
	libaprutil1-dev \
	libbrotli-dev \
	libcurl4-openssl-dev \
	libjansson-dev \
	liblua5.2-dev \
	libnghttp2-dev \
	libpcre3-dev \
	libssl-dev \
	libxml2-dev \
	zlib1g-dev 

RUN wget https://archive.apache.org/dist/httpd/httpd-2.4.50.tar.bz2 ; tar xvf httpd-2.4.50.tar.bz2
RUN ./httpd-2.4.50/configure --enable-cgi --sysconfdir=/etc/apache2 --prefix=/usr/local/apache2
RUN make ; make clean install
RUN mkdir -p /var/www/html
RUN cp -r /usr/local/apache2/cgi-bin/ /var/www/html/
RUN cp /usr/local/apache2/htdocs/index.html /var/www/html

RUN sed -i '/<Directory \/>/,/<\/Directory>/s/Require all denied/Require all granted/' /etc/apache2/httpd.conf
RUN sed -i 's|ScriptAlias "/cgi-bin/" "/usr/local/apache2/cgi-bin/"|ScriptAlias "/cgi-bin/" "/var/www/html/cgi-bin"|' /etc/apache2/httpd.conf
RUN sed -i 's|DocumentRoot "/etc/local/apache2/htdocs"|DocumentRoot "/var/www/html"|' /etc/apache2/httpd.conf
RUN sed -i 's|<Directory "/usr/local/apache2/htdocs">|<Directory "/var/www/html">|' /etc/apache2/httpd.conf

RUN cat <<EOL >> /etc/apache2/httpd.conf
<Directory "/var/www/html">
    Options +ExecCGI
    AddHandler cgi-script .cgi .pl
</Directory>

<Directory "/var/www/html/cgi-bin">
    Options +ExecCGI
    AllowOverride None
    Require all granted
</Directory>

LoadModule cgi_module modules/mod_cgi.so
EOL


# CMD ["/usr/local/apache2/bin/apachectl", "-D", "FOREGROUND"]